#!/bin/bash

cd /

while :
do

if test -e /tmp/regataos-prime/use-hybrid-graphics.txt ; then

	if test -e /usr/bin/nvidia-xconfig ; then

		rm -f "/etc/modprobe.d/blacklist-regataos-nouveau.conf"
		rm -f "/tmp/regataos-prime/not-hybrid-graphics.txt"
		rm -f "/tmp/regataos-prime/use-hybrid-graphics-amd.txt"

    	rm -f "/etc/X11/xorg.conf.d/20-amdgpu.conf"
    	rm -f "/usr/share/X11/xorg.conf.d/20-amdgpu.conf"
    	rm -f "/etc/X11/xorg.conf.d/20-radeon.conf"
    	rm -f "/usr/share/X11/xorg.conf.d/20-radeon.conf"
    	rm -f "/etc/X11/xorg.conf.d/20-intel.conf"
    	rm -f "/usr/share/X11/xorg.conf.d/20-intel.conf"
		rm -f "/etc/X11/xorg.conf.d/20-nvidia.conf"
    	rm -f "/usr/share/X11/xorg.conf.d/20-nvidia.conf"

		echo NVIDIA > /usr/share/regataos/use-hybrid-graphics-nvidia.txt
		echo NVIDIA > /tmp/regataos-prime/use-hybrid-graphics-nvidia.txt
		echo NVIDIA > /tmp/regataos-prime/nvidia-driver.txt

		sudo /usr/bin/prime-settings-system-info.sh start

		# Open apps with hybrid graphics manually
		cp -f /usr/share/regataos/gpu/prime/prime-gpu.desktop /usr/share/kservices5/ServiceMenus/prime-gpu.desktop

		# desktop file for prime settings
		cp -f /usr/share/regataos/gpu/prime/prime-settings.desktop /usr/share/applications/prime-settings.desktop
		update-desktop-database

		sudo /usr/share/regataos/gpu/prime/apps-hybrid-graphics start

	else

		kmsg=$(lshw -class display)
		echo $kmsg

		if [[ $kmsg == *"AMD"* ]]; then
			echo AMD > /tmp/regataos-prime/use-hybrid-graphics-amd.txt
			rm -f "/tmp/regataos-prime/use-hybrid-graphics-nvidia.txt"
			rm -f "/tmp/regataos-prime/not-hybrid-graphics.txt"
			rm -f "/tmp/regataos-prime/nvidia-driver.txt"

			sudo /usr/bin/prime-settings-system-info.sh start

		elif [[ $kmsg == *"ATI"* ]]; then
			echo AMD > /tmp/regataos-prime/use-hybrid-graphics-amd.txt
			rm -f "/tmp/regataos-prime/use-hybrid-graphics-nvidia.txt"
			rm -f "/tmp/regataos-prime/not-hybrid-graphics.txt"
			rm -f "/tmp/regataos-prime/nvidia-driver.txt"

			sudo /usr/bin/prime-settings-system-info.sh start

		elif [[ $kmsg == *"Radeon"* ]]; then
			echo AMD > /tmp/regataos-prime/use-hybrid-graphics-amd.txt
			rm -f "/tmp/regataos-prime/use-hybrid-graphics-nvidia.txt"
			rm -f "/tmp/regataos-prime/not-hybrid-graphics.txt"
			rm -f "/tmp/regataos-prime/nvidia-driver.txt"

			sudo /usr/bin/prime-settings-system-info.sh start

		elif [[ $kmsg == *"NVIDIA"* ]]; then
			echo NVIDIA > /tmp/regataos-prime/use-hybrid-graphics-nvidia.txt
			rm -f "/tmp/regataos-prime/use-hybrid-graphics-amd.txt"
			rm -f "/tmp/regataos-prime/not-hybrid-graphics.txt"
			rm -f "/tmp/regataos-prime/nvidia-driver.txt"

			sudo /usr/bin/prime-settings-system-info.sh start

			rm -f "/etc/modprobe.d/blacklist-regataos-nouveau.conf"
			sudo bash -c "echo options nouveau modeset=0 >> /etc/modprobe.d/blacklist-regataos-nouveau.conf"

		elif [[ $kmsg == *"GeForce"* ]]; then
			echo NVIDIA > /tmp/regataos-prime/use-hybrid-graphics-nvidia.txt
			rm -f "/tmp/regataos-prime/use-hybrid-graphics-amd.txt"
			rm -f "/tmp/regataos-prime/not-hybrid-graphics.txt"
			rm -f "/tmp/regataos-prime/nvidia-driver.txt"

			sudo /usr/bin/prime-settings-system-info.sh start

			rm -f "/etc/modprobe.d/blacklist-regataos-nouveau.conf"
			sudo bash -c "echo options nouveau modeset=0 >> /etc/modprobe.d/blacklist-regataos-nouveau.conf"

		else

			kmsg=$(DRI_PRIME=1 glxinfo | grep "OpenGL renderer")
			echo $kmsg

			if [[ $kmsg == *"AMD"* ]]; then
				echo AMD > /tmp/regataos-prime/use-hybrid-graphics-amd.txt
				rm -f "/tmp/regataos-prime/use-hybrid-graphics-nvidia.txt"
				rm -f "/tmp/regataos-prime/not-hybrid-graphics.txt"
				rm -f "/tmp/regataos-prime/nvidia-driver.txt"

				sudo /usr/bin/prime-settings-system-info.sh start

			elif [[ $kmsg == *"ATI"* ]]; then
				echo AMD > /tmp/regataos-prime/use-hybrid-graphics-amd.txt
				rm -f "/tmp/regataos-prime/use-hybrid-graphics-nvidia.txt"
				rm -f "/tmp/regataos-prime/not-hybrid-graphics.txt"
				rm -f "/tmp/regataos-prime/nvidia-driver.txt"

				sudo /usr/bin/prime-settings-system-info.sh start

			elif [[ $kmsg == *"Radeon"* ]]; then
				echo AMD > /tmp/regataos-prime/use-hybrid-graphics-amd.txt
				rm -f "/tmp/regataos-prime/use-hybrid-graphics-nvidia.txt"
				rm -f "/tmp/regataos-prime/not-hybrid-graphics.txt"
				rm -f "/tmp/regataos-prime/nvidia-driver.txt"

				sudo /usr/bin/prime-settings-system-info.sh start

			elif [[ $kmsg == *"NVIDIA"* ]]; then
				echo NVIDIA > /tmp/regataos-prime/use-hybrid-graphics-nvidia.txt
				rm -f "/tmp/regataos-prime/use-hybrid-graphics-amd.txt"
				rm -f "/tmp/regataos-prime/not-hybrid-graphics.txt"
				rm -f "/tmp/regataos-prime/nvidia-driver.txt"

				sudo /usr/bin/prime-settings-system-info.sh start

				rm -f "/etc/modprobe.d/blacklist-regataos-nouveau.conf"
				sudo bash -c "echo options nouveau modeset=0 >> /etc/modprobe.d/blacklist-regataos-nouveau.conf"

			elif [[ $kmsg == *"GeForce"* ]]; then
				echo NVIDIA > /tmp/regataos-prime/use-hybrid-graphics-nvidia.txt
				rm -f "/tmp/regataos-prime/use-hybrid-graphics-amd.txt"
				rm -f "/tmp/regataos-prime/not-hybrid-graphics.txt"
				rm -f "/tmp/regataos-prime/nvidia-driver.txt"

				sudo /usr/bin/prime-settings-system-info.sh start

				rm -f "/etc/modprobe.d/blacklist-regataos-nouveau.conf"
				sudo bash -c "echo options nouveau modeset=0 >> /etc/modprobe.d/blacklist-regataos-nouveau.conf"

			elif [[ $kmsg == *"NV"* ]]; then
				echo NVIDIA > /tmp/regataos-prime/use-hybrid-graphics-nvidia.txt
				rm -f "/tmp/regataos-prime/use-hybrid-graphics-amd.txt"
				rm -f "/tmp/regataos-prime/not-hybrid-graphics.txt"
				rm -f "/tmp/regataos-prime/nvidia-driver.txt"

				sudo /usr/bin/prime-settings-system-info.sh start

				rm -f "/etc/modprobe.d/blacklist-regataos-nouveau.conf"
				sudo bash -c "echo options nouveau modeset=0 >> /etc/modprobe.d/blacklist-regataos-nouveau.conf"

			else
				echo "No detect dGPU"
			fi
		fi

		# Open apps with hybrid graphics manually
		cp -f /usr/share/regataos/gpu/prime/prime-gpu.desktop /usr/share/kservices5/ServiceMenus/prime-gpu.desktop

		# desktop file for prime settings
		cp -f /usr/share/regataos/gpu/prime/prime-settings.desktop /usr/share/applications/prime-settings.desktop
		update-desktop-database

		sudo /usr/share/regataos/gpu/prime/apps-hybrid-graphics start
	fi

if test -e /tmp/regataos-prime/use-hybrid-graphics-nvidia.txt ; then
	break
fi

if test -e /tmp/regataos-prime/use-hybrid-graphics-amd.txt ; then
	break
fi

else

	if test -e /tmp/regataos-prime/not-hybrid-graphics.txt ; then

		echo "There seems to be no hybrid graphics"
		if test -e /usr/share/kservices5/ServiceMenus/prime-gpu.desktop ; then
			rm -f "/usr/share/kservices5/ServiceMenus/prime-gpu.desktop"
		fi

		if test -e /usr/share/applications/prime-settings.desktop ; then
			rm -f "/usr/share/applications/prime-settings.desktop"
		fi

	else
		echo "Check for hybrid graphics"
	fi

fi

   sleep 10
done
